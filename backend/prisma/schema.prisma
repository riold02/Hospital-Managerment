// Prisma schema for PostgreSQL
// Authorization handled at application level (staff.role)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model patients {
  patient_id              Int       @id @default(autoincrement())
  patient_code            String    @unique @db.VarChar(20)
  user_id                 String?   @unique @db.Uuid  // Link to users table
  first_name              String    @db.VarChar(50)
  last_name               String    @db.VarChar(50)
  date_of_birth           DateTime? @db.Date
  gender                  String?   @db.VarChar(10) // CHECK constraint: ('male', 'female', 'other')
  phone                   String?   @db.VarChar(20)
  email                   String?   @db.VarChar(100)
  address                 String?
  emergency_contact_name  String?   @db.VarChar(100)
  emergency_contact_phone String?   @db.VarChar(20)
  blood_type              String?   @db.VarChar(5)
  allergies               String?
  medical_history         String?
  insurance_number        String?   @db.VarChar(50)
  is_active               Boolean?  @default(true)
  created_at              DateTime? @default(now()) @db.Timestamptz
  updated_at              DateTime? @default(now()) @db.Timestamptz

  // Relationships
  user            users?    @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  ambulance_log   ambulance_log[]
  appointments    appointments[]
  medical_records medical_records[]
  billing         billing[]
  pharmacy        pharmacy[]
  prescriptions   prescriptions[]
  room_assignments room_assignments[]
  nurse_patient_assignments nurse_patient_assignments[]

  @@map("patients")
}

model ambulance {
  ambulance_id     Int       @id @default(autoincrement())
  ambulance_number String?   @db.VarChar(10)
  availability     String?   @db.VarChar(15)
  driver_id        Int?
  driver_user_id   String?   @db.Uuid  // Link to users table
  last_service_date DateTime?

  // Relationships
  driver_user     users?    @relation(fields: [driver_user_id], references: [user_id], onDelete: SetNull)
  ambulance_log    ambulance_log[]

  @@unique([ambulance_number])
  @@map("ambulance")
}

model ambulance_log {
  log_id          Int       @id @default(autoincrement())
  ambulance_id    Int?
  patient_id      Int?
  pickup_location String?   @db.VarChar(100)
  dropoff_location String?  @db.VarChar(100)
  pickup_time     DateTime? @db.Timestamptz
  dropoff_time    DateTime? @db.Timestamptz
  status          String?   @db.VarChar(15)

  ambulance       ambulance? @relation(fields: [ambulance_id], references: [ambulance_id], onDelete: Cascade)
  patient         patients?  @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)

  @@map("ambulance_log")
}

model departments {
  department_id   Int                @id @default(autoincrement())
  department_name String?            @db.VarChar(50)
  location        String?            @db.VarChar(100)

  staff           staff[]
  doctor_department doctor_department[]

  @@map("departments")
}

model doctors {
  doctor_id        Int                @id @default(autoincrement())
  user_id          String?            @unique @db.Uuid  // Link to users table
  first_name       String             @db.VarChar(50)
  last_name        String             @db.VarChar(50)
  specialty        String             @db.VarChar(100)
  phone            String?            @db.VarChar(15)  // Changed from contact_number to phone
  email            String?            @db.VarChar(100)
  available_schedule String?
  created_at       DateTime?          @default(now()) @db.Timestamptz

  // Relationships
  user             users?             @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  doctor_department doctor_department[]
  appointments      appointments[]
  medical_records   medical_records[]
  prescriptions     prescriptions[]

  @@map("doctors")
}

model doctor_department {
  doctor_id     Int
  department_id Int

  doctors      doctors    @relation(fields: [doctor_id], references: [doctor_id], onDelete: Cascade)
  departments  departments @relation(fields: [department_id], references: [department_id], onDelete: Cascade)

  @@id([doctor_id, department_id])
  @@map("doctor_department")
}

model staff {
  staff_id       Int        @id @default(autoincrement())
  user_id        String?    @unique @db.Uuid  // Link to users table
  first_name     String?
  last_name      String?
  role           String
  position       String?    @db.VarChar(100)
  department_id  Int?
  phone          String?    @db.VarChar(15)  // Changed from contact_number to phone
  email          String?    @db.VarChar(100)
  address        String?
  hire_date      DateTime?
  created_at     DateTime?  @default(now()) @db.Timestamptz

  // Relationships
  user             users?       @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  departments      departments? @relation(fields: [department_id], references: [department_id], onDelete: SetNull)
  room_assignments room_assignments[]
  cleaning_service cleaning_service[]
  nurse_patient_assignments nurse_patient_assignments[]

  @@map("staff")
}

model room_types {
  room_type_id   Int      @id @default(autoincrement())
  type_name      String   @db.VarChar(50)
  description    String?
  base_price     Decimal? @db.Decimal(10, 2)
  created_at     DateTime? @default(now()) @db.Timestamptz
  updated_at     DateTime? @default(now()) @db.Timestamptz
  rooms          rooms[]

  @@map("room_types")
}

model rooms {
  room_id           Int       @id @default(autoincrement())
  room_number       String    @db.VarChar(10)
  room_type_id      Int?
  department_id     Int?
  capacity          Int?      @default(1)
  current_occupancy Int?      @default(0)
  status            String?   @default("available") @db.VarChar(20)
  floor_number      Int?
  building          String?   @db.VarChar(50)
  daily_rate        Decimal?  @db.Decimal(10, 2)
  equipment         Json?     @db.JsonB
  last_cleaned      DateTime? @db.Timestamptz
  description       String?   @db.Text
  is_active         Boolean?  @default(true)
  created_at        DateTime? @default(now()) @db.Timestamptz
  updated_at        DateTime? @default(now()) @db.Timestamptz

  room_type        room_types? @relation(fields: [room_type_id], references: [room_type_id], onDelete: SetNull)
  room_assignments room_assignments[]
  cleaning_service cleaning_service[]

  @@unique([room_number])
  @@map("rooms")
}

model medicine {
  medicine_id    Int       @id @default(autoincrement())
  name           String     @db.VarChar(100)
  brand          String?    @db.VarChar(50)
  type           String?    @db.VarChar(20)
  dosage         String?    @db.VarChar(50)
  stock_quantity Int?
  expiry_date    DateTime?
  created_at     DateTime?  @default(now()) @db.Timestamptz

  pharmacy       pharmacy[]
  prescription_items prescription_items[]

  @@map("medicine")
}

model appointments {
  appointment_id   Int       @id @default(autoincrement())
  patient_id       Int
  doctor_id        Int?
  appointment_date DateTime
  appointment_time DateTime  @db.Time
  purpose          String?   @db.VarChar(255)
  status           String?   @db.VarChar(20) @default("Scheduled")
  created_at       DateTime? @default(now()) @db.Timestamptz

  patient          patients  @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  doctor           doctors?  @relation(fields: [doctor_id], references: [doctor_id], onDelete: SetNull)
  medical_records  medical_records[]
  billing          billing[]

  @@map("appointments")
}

model medical_records {
  record_id       Int       @id @default(autoincrement())
  patient_id      Int
  doctor_id       Int?
  appointment_id  Int?
  created_by_user_id String? @db.Uuid  // Who created/updated the record
  diagnosis       String?
  treatment       String?
  prescription    String?
  created_at      DateTime? @default(now()) @db.Timestamptz

  // Relationships
  patient         patients     @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  doctor          doctors?     @relation(fields: [doctor_id], references: [doctor_id], onDelete: SetNull)
  appointment     appointments? @relation(fields: [appointment_id], references: [appointment_id], onDelete: NoAction)
  created_by_user users?       @relation(fields: [created_by_user_id], references: [user_id], onDelete: SetNull)
  billing         billing[]    // Hồ sơ y tế có thể tạo nhiều hóa đơn

  @@map("medical_records")
}

model services {
  service_id         Int       @id @default(autoincrement())
  service_name       String    @db.VarChar(200)
  service_code       String    @unique @db.VarChar(50)
  description        String?
  category           String?   @db.VarChar(100)
  unit_price         Decimal   @db.Decimal(12,2)
  unit               String?   @default("unit") @db.VarChar(50)
  is_active          Boolean?  @default(true)
  requires_doctor    Boolean?  @default(false)
  estimated_duration Int?      // in minutes
  created_at         DateTime? @default(now()) @db.Timestamptz
  updated_at         DateTime? @default(now()) @db.Timestamptz

  // Relationships
  billing_items billing_items[]

  @@map("services")
}

model billing {
  bill_id            Int       @id @default(autoincrement())
  patient_id         Int
  appointment_id     Int?
  medical_record_id  Int?
  processed_by_user_id String? @db.Uuid  // Who processed the billing
  billing_date       DateTime? @default(now()) @db.Timestamptz  // Date of billing
  total_amount       Decimal   @db.Decimal(10,2)
  payment_status     String?   @db.VarChar(20) @default("Pending")
  payment_date       DateTime?
  payment_method     String?   @db.VarChar(50)  // CASH or TRANSFER
  insurance_provider String?   @db.VarChar(100)
  created_at         DateTime? @default(now()) @db.Timestamptz

  // Relationships
  patient            patients     @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  appointment        appointments? @relation(fields: [appointment_id], references: [appointment_id], onDelete: NoAction)
  medical_record     medical_records? @relation(fields: [medical_record_id], references: [record_id], onDelete: SetNull)
  processed_by_user  users?       @relation(fields: [processed_by_user_id], references: [user_id], onDelete: SetNull)
  items              billing_items[]
  payment_transactions payment_transactions[]

  @@map("billing")
}

model billing_items {
  item_id          Int       @id @default(autoincrement())
  bill_id          Int
  service_id       Int?
  item_description String    @db.VarChar(300)
  quantity         Decimal   @default(1) @db.Decimal(10,2)
  unit_price       Decimal   @db.Decimal(12,2)
  discount_amount  Decimal   @default(0) @db.Decimal(12,2)
  tax_amount       Decimal   @default(0) @db.Decimal(12,2)
  total_amount     Decimal   @db.Decimal(12,2)
  notes            String?
  created_at       DateTime? @default(now()) @db.Timestamptz

  // Relationships
  bill    billing   @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)
  service services? @relation(fields: [service_id], references: [service_id], onDelete: SetNull)

  @@map("billing_items")
}

model payment_transactions {
  transaction_id          Int       @id @default(autoincrement())
  bill_id                 Int
  payment_gateway         String    @db.VarChar(20) // 'MOMO', 'VNPAY', 'CASH'
  transaction_code        String?   @unique @db.VarChar(100)
  amount                  Decimal   @db.Decimal(12,2)
  status                  String    @default("PENDING") @db.VarChar(20) // 'PENDING', 'SUCCESS', 'FAILED', 'CANCELLED'
  payment_url             String?   @db.Text
  gateway_transaction_id  String?   @db.VarChar(100)
  gateway_response        Json?     @db.JsonB
  paid_at                 DateTime? @db.Timestamptz
  created_at              DateTime? @default(now()) @db.Timestamptz
  updated_at              DateTime? @default(now()) @db.Timestamptz

  // Relationships
  bill billing @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)

  @@index([bill_id])
  @@index([transaction_code])
  @@index([status])
  @@map("payment_transactions")
}

model pharmacy {
  pharmacy_id       Int       @id @default(autoincrement())
  medicine_id       Int?
  patient_id        Int?
  dispensed_by_user_id String? @db.Uuid  // Who dispensed the medicine
  quantity          Int?
  prescription_date DateTime?

  // Relationships
  medicine          medicine? @relation(fields: [medicine_id], references: [medicine_id], onDelete: Cascade)
  patient           patients? @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  dispensed_by_user users?    @relation(fields: [dispensed_by_user_id], references: [user_id], onDelete: SetNull)

  @@map("pharmacy")
}

model prescriptions {
  prescription_id   Int       @id @default(autoincrement())
  patient_id        Int
  prescribed_by     Int       // doctor_id
  prescribed_by_user_id String? @db.Uuid  // User who prescribed (should match doctor's user_id)
  prescription_date DateTime? @default(now())
  diagnosis         String?   @db.VarChar(500)  // Chẩn đoán
  instructions      String?   @db.VarChar(500)  // Lời dặn chung
  status            String?   @db.VarChar(20) @default("Active")
  created_at        DateTime? @default(now()) @db.Timestamptz
  updated_at        DateTime? @updatedAt @db.Timestamptz

  // Relationships
  patient           patients @relation(fields: [patient_id], references: [patient_id])
  doctor            doctors  @relation(fields: [prescribed_by], references: [doctor_id])
  prescribed_by_user users?  @relation(fields: [prescribed_by_user_id], references: [user_id], onDelete: SetNull)
  items             prescription_items[]  // One prescription has many items

  @@map("prescriptions")
}

// Chi tiết đơn thuốc - mỗi item là 1 loại thuốc
model prescription_items {
  item_id         Int       @id @default(autoincrement())
  prescription_id Int
  medicine_id     Int
  quantity        Int       @default(1)
  dosage          String?   @db.VarChar(100)  // Liều dùng: "500mg"
  frequency       String?   @db.VarChar(100)  // Tần suất: "2 lần/ngày"
  duration        String?   @db.VarChar(100)  // Thời gian: "7 ngày"
  instructions    String?   @db.VarChar(255)  // Lời dặn riêng cho thuốc này
  created_at      DateTime? @default(now()) @db.Timestamptz

  // Relationships
  prescription    prescriptions @relation(fields: [prescription_id], references: [prescription_id], onDelete: Cascade)
  medicine        medicine     @relation(fields: [medicine_id], references: [medicine_id])

  @@map("prescription_items")
}

model room_assignments {
  assignment_id   Int       @id @default(autoincrement())
  room_id         Int?
  assignment_type String?   @db.VarChar(20) // 'Patient' or 'Staff'  
  staff_id        Int?
  patient_id      Int?
  assigned_by_user_id String? @db.Uuid  // Who made the assignment
  start_date      DateTime  @default(now()) @db.Timestamptz
  end_date        DateTime? @db.Timestamptz
  created_at      DateTime? @default(now()) @db.Timestamptz

  // Relationships
  room            rooms?    @relation(fields: [room_id], references: [room_id], onDelete: Cascade)
  staff           staff?    @relation(fields: [staff_id], references: [staff_id], onDelete: SetNull)
  patient         patients? @relation(fields: [patient_id], references: [patient_id], onDelete: SetNull)
  assigned_by_user users?   @relation(fields: [assigned_by_user_id], references: [user_id], onDelete: SetNull)

  @@map("room_assignments")
}

model nurse_patient_assignments {
  assignment_id       Int       @id @default(autoincrement())
  nurse_id            Int
  patient_id          Int
  assigned_by_user_id String?   @db.Uuid
  start_date          DateTime  @default(now()) @db.Date
  end_date            DateTime? @db.Date
  shift_type          String?   @db.VarChar(20) // 'morning', 'afternoon', 'night', 'all_day'
  priority            String?   @default("normal") @db.VarChar(20) // 'normal', 'high', 'critical'
  notes               String?
  status              String?   @default("active") @db.VarChar(20) // 'active', 'completed', 'cancelled', 'transferred'
  created_at          DateTime  @default(now()) @db.Timestamptz
  updated_at          DateTime  @default(now()) @db.Timestamptz

  // Relationships
  nurse               staff     @relation(fields: [nurse_id], references: [staff_id], onDelete: Cascade)
  patient             patients  @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  assigned_by_user    users?    @relation(fields: [assigned_by_user_id], references: [user_id], onDelete: SetNull)

  @@unique([nurse_id, patient_id, start_date])
  @@map("nurse_patient_assignments")
}

model cleaning_service {
  cleaning_id    Int       @id @default(autoincrement())
  room_id        Int?
  cleaning_date  DateTime? @default(now())
  cleaning_type  String?   @db.VarChar(50)
  cleaned_by     Int?      // staff_id
  cleaned_by_user_id String? @db.Uuid  // User who performed cleaning
  status         String?   @db.VarChar(20) @default("Completed")
  notes          String?   @db.VarChar(255)
  created_at     DateTime? @default(now()) @db.Timestamptz

  // Relationships
  room           rooms?    @relation(fields: [room_id], references: [room_id])
  staff          staff?    @relation(fields: [cleaned_by], references: [staff_id])
  cleaned_by_user users?   @relation(fields: [cleaned_by_user_id], references: [user_id], onDelete: SetNull)

  @@map("cleaning_service")
}

// ============================================================================
// RBAC SYSTEM - Role-Based Access Control
// ============================================================================

model users {
  user_id       String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(100)
  password_hash String?   @db.VarChar(255)
  is_active     Boolean   @default(true)
  last_login    DateTime? @db.Timestamptz
  created_at    DateTime  @default(now()) @db.Timestamptz
  updated_at    DateTime  @updatedAt @db.Timestamptz

  // Relationships
  user_roles            user_roles[]
  user_roles_assigned   user_roles[] @relation("UserRolesAssignedBy")
  patient               patients?
  staff_member          staff?
  doctor                doctors?
  password_reset_tokens password_reset_tokens[]
  
  // Business activity relationships
  ambulance_driver      ambulance[]
  medical_records_created medical_records[]
  prescriptions_written prescriptions[]
  billing_processed     billing[]
  pharmacy_dispensed    pharmacy[]
  room_assignments_made room_assignments[]
  cleaning_services_performed cleaning_service[]
  nurse_patient_assignments_made nurse_patient_assignments[]

  @@map("users")
}

model roles {
  role_id     Int      @id @default(autoincrement())
  role_name   String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz
  updated_at  DateTime @updatedAt @db.Timestamptz

  // Relationships
  user_roles       user_roles[]
  role_permissions role_permissions[]

  @@map("roles")
}

model permissions {
  permission_id   Int      @id @default(autoincrement())
  permission_name String   @unique @db.VarChar(100)
  resource        String   @db.VarChar(50)  // e.g., 'patients', 'appointments'
  action          String   @db.VarChar(50)  // e.g., 'create', 'read', 'update', 'delete'
  description     String?  @db.VarChar(255)
  created_at      DateTime @default(now()) @db.Timestamptz

  // Relationships
  role_permissions role_permissions[]

  @@unique([resource, action])
  @@map("permissions")
}

model user_roles {
  user_role_id Int      @id @default(autoincrement())
  user_id      String   @db.Uuid
  role_id      Int
  assigned_at  DateTime @default(now()) @db.Timestamptz
  assigned_by  String?  @db.Uuid
  is_active    Boolean? @default(true)

  // Relationships
  user       users    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role       roles    @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  assigned_by_user users? @relation("UserRolesAssignedBy", fields: [assigned_by], references: [user_id])

  @@unique([user_id, role_id])
  @@map("user_roles")
}

model role_permissions {
  role_permission_id Int       @id @default(autoincrement())
  role_id            Int
  permission_id      Int
  created_at         DateTime? @default(now()) @db.Timestamp

  // Relationships
  role          roles       @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  permission    permissions @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade)

  @@unique([role_id, permission_id])
  @@map("role_permissions")
}

// ============================================================================
// PASSWORD RESET TOKENS - For forgot password functionality
// ============================================================================

model password_reset_tokens {
  token_id    String    @id @default(uuid()) @db.Uuid
  user_id     String    @db.Uuid
  token_hash  String    @db.VarChar(255)  // Hashed reset token
  expires_at  DateTime  @db.Timestamptz   // Token expiration time
  used_at     DateTime? @db.Timestamptz   // When token was used (null = not used)
  created_at  DateTime  @default(now()) @db.Timestamptz

  // Relationships
  user        users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([token_hash])
  @@index([user_id])
  @@index([expires_at])
  @@map("password_reset_tokens")
}